name: PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: PR Review with Claude
        id: review
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          github_token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: true
          show_full_output: true
          prompt: |
            è¯·å¯¹å½“å‰ PR è¿›è¡Œå…¨é¢å®¡æŸ¥.

            ## å®¡æŸ¥ç»´åº¦

            **ä»£ç è´¨é‡**ï¼šä»£ç é£æ ¼ã€å¤æ‚åº¦ã€é‡å¤ä»£ç ã€å‘½åè§„èŒƒã€é”™è¯¯å¤„ç†ã€æ½œåœ¨ bug

            **æ¶æ„è®¾è®¡**ï¼šé¡¹ç›®ç»“æ„ä¸€è‡´æ€§ã€ä¾èµ–åˆç†æ€§ã€è®¾è®¡æ¨¡å¼ã€å…³æ³¨ç‚¹åˆ†ç¦»

            ## è¾“å‡ºæ ¼å¼ï¼ˆç®€ä½“ä¸­æ–‡ï¼‰

            è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºå®¡æŸ¥æŠ¥å‘Š, ä½œä¸ºï¼š

            ## ğŸ” PR ä»£ç å®¡æŸ¥æŠ¥å‘Š

            ### ğŸ“‹ æ¦‚è¦
            - **å˜æ›´æ–‡ä»¶æ•°**: {changedFiles}
            - **æ–°å¢/åˆ é™¤è¡Œæ•°**: +{additions} / -{deletions}

            ### ğŸ¯ å®¡æŸ¥ç»“è®º
            {APPROVE/REQUEST_CHANGES/COMMENT åŠç®€è¦è¯´æ˜}

            ### ğŸ”´ ä¸¥é‡é—®é¢˜ (Critical)
            {ä¸¥é‡é—®é¢˜åˆ—è¡¨ï¼Œå¦‚æ— åˆ™æ˜¾ç¤º"æ— "}

            ### ğŸŸ  é‡è¦é—®é¢˜ (Important)
            {é‡è¦é—®é¢˜åˆ—è¡¨ï¼Œå¦‚æ— åˆ™æ˜¾ç¤º"æ— "}

            ### ğŸŸ¢ æ”¹è¿›å»ºè®® (Suggestions)
            {æ”¹è¿›å»ºè®®åˆ—è¡¨ï¼Œå¦‚æ— åˆ™æ˜¾ç¤º"æ— "}

            ### ğŸ’¡ æ€»ä½“è¯„ä»·
            {å¯¹æœ¬æ¬¡ PR çš„æ•´ä½“è¯„ä»·}

            ## æ³¨æ„äº‹é¡¹
            1. æ‰€æœ‰è¯„è®ºä½¿ç”¨ç®€ä½“ä¸­æ–‡
            2. ç»™å‡ºå…·ä½“çš„æ–‡ä»¶åå’Œè¡Œå·
            3. å¯¹å¥½çš„å®è·µä¹Ÿè¦ç»™äºˆè‚¯å®š
            4. ä¿æŒå®¢è§‚ã€ä¸“ä¸š

            Note: The PR branch is already checked out in the current working directory.

            Use `gh pr comment` to post ONE comprehensive review comment.
            Include all issues (critical, important, and suggestions) with file paths and line numbers in the single comment.
            Do NOT create multiple comments or inline comments.
            Only post GitHub comments - don't submit review text as messages.

            ALWAYS Answer in ç®€ä½“ä¸­æ–‡.
          claude_args: |
            --allowedTools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,Glob,Grep,Task" --json-schema '{"type":"object","properties":{"conclusion":{"type":"string","enum":["APPROVE","REQUEST_CHANGES","COMMENT"]},"summary":{"type":"string","maxLength":50},"critical_count":{"type":"integer"},"important_count":{"type":"integer"},"suggestion_count":{"type":"integer"}},"required":["conclusion","summary","critical_count","important_count","suggestion_count"]}'
      - name: Notify Feishu
        if: always()
        run: |
          STATUS="${{ job.status }}"

          # è§£æç»“æ„åŒ–è¾“å‡º
          STRUCTURED_OUTPUT='${{ steps.review.outputs.structured_output }}'
          if [ -n "$STRUCTURED_OUTPUT" ] && [ "$STRUCTURED_OUTPUT" != "null" ]; then
            CONCLUSION=$(echo "$STRUCTURED_OUTPUT" | jq -r '.conclusion // "UNKNOWN"')
            SUMMARY=$(echo "$STRUCTURED_OUTPUT" | jq -r '.summary // "å®¡æŸ¥å®Œæˆ"')
            CRITICAL=$(echo "$STRUCTURED_OUTPUT" | jq -r '.critical_count // 0')
            IMPORTANT=$(echo "$STRUCTURED_OUTPUT" | jq -r '.important_count // 0')
            SUGGESTION=$(echo "$STRUCTURED_OUTPUT" | jq -r '.suggestion_count // 0')
          else
            CONCLUSION="UNKNOWN"
            SUMMARY="æœªè·å–åˆ°å®¡æŸ¥ç»“æœ"
            CRITICAL=0
            IMPORTANT=0
            SUGGESTION=0
          fi

          # æ ¹æ®ç»“è®ºè®¾ç½®æ ·å¼
          case "$CONCLUSION" in
            "APPROVE")
              EMOJI="âœ…"
              TEMPLATE="green"
              ;;
            "REQUEST_CHANGES")
              EMOJI="âŒ"
              TEMPLATE="red"
              ;;
            *)
              EMOJI="ğŸ’¬"
              TEMPLATE="blue"
              ;;
          esac

          if [ "$STATUS" != "success" ]; then
            EMOJI="âš ï¸"
            TEMPLATE="orange"
            SUMMARY="Action æ‰§è¡Œå¼‚å¸¸"
          fi

          curl -X POST "https://open.feishu.cn/open-apis/bot/v2/hook/${{ secrets.FEISHU_WEBHOOK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "interactive",
              "card": {
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": "'"${EMOJI} PR Review - ${CONCLUSION}"'"
                  },
                  "template": "'"${TEMPLATE}"'"
                },
                "elements": [
                  {
                    "tag": "div",
                    "fields": [
                      {
                        "is_short": true,
                        "text": {
                          "tag": "lark_md",
                          "content": "**ä»“åº“**\n${{ github.repository }}"
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "tag": "lark_md",
                          "content": "**PR**\n#${{ github.event.pull_request.number }}"
                        }
                      }
                    ]
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**æ ‡é¢˜**: ${{ github.event.pull_request.title }}"
                    }
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**å®¡æŸ¥ç»“æœ**: '"${SUMMARY}"'"
                    }
                  },
                  {
                    "tag": "div",
                    "fields": [
                      {
                        "is_short": true,
                        "text": {
                          "tag": "lark_md",
                          "content": "ğŸ”´ ä¸¥é‡: '"${CRITICAL}"'"
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "tag": "lark_md",
                          "content": "ğŸŸ  é‡è¦: '"${IMPORTANT}"'"
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "tag": "lark_md",
                          "content": "ğŸŸ¢ å»ºè®®: '"${SUGGESTION}"'"
                        }
                      }
                    ]
                  },
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "æŸ¥çœ‹ PR"
                        },
                        "type": "primary",
                        "url": "${{ github.event.pull_request.html_url }}"
                      }
                    ]
                  }
                ]
              }
            }'
