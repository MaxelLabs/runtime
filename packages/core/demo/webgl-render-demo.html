<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maxellabs 3D Engine - WebGL RHI 渲染演示</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .demo-section {
            margin-bottom: 30px;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #webglCanvas {
            width: 100%;
            height: 500px;
            display: block;
            background: linear-gradient(45deg, #000428, #004e92);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .control-group h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1em;
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
            width: calc(100% - 10px);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .info-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .label {
            font-weight: bold;
            color: #495057;
        }

        .value {
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ready { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-loading { background: #ffc107; }

        .code-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎮 Maxellabs 3D Engine WebGL RHI 演示</h1>
        
        <div class="demo-section">
            <div class="canvas-container">
                <canvas id="webglCanvas"></canvas>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>🎯 渲染控制</h3>
                <button onclick="demo.startRender()">开始渲染</button>
                <button onclick="demo.stopRender()">停止渲染</button>
                <button onclick="demo.clearCanvas()">清空画布</button>
                <button onclick="demo.testCoreRenderer()">测试 Core 渲染器</button>
            </div>

            <div class="control-group">
                <h3>🔧 设备信息</h3>
                <button onclick="demo.showDeviceInfo()">显示设备信息</button>
                <button onclick="demo.checkExtensions()">检查扩展</button>
                <button onclick="demo.showRHICapabilities()">RHI 能力</button>
                <button onclick="demo.logToConsole()">控制台日志</button>
            </div>

            <div class="control-group">
                <h3>📊 调试信息</h3>
                <button onclick="demo.exportDeviceInfo()">导出设备信息</button>
                <button onclick="demo.testWebGLFeatures()">测试 WebGL 特性</button>
                <button onclick="demo.measurePerformance()">性能测试</button>
            </div>
        </div>

        <div id="infoPanel" class="info-panel">
            <div class="info-row">
                <span class="label">状态:</span>
                <span class="value">
                    <span id="statusIndicator" class="status-indicator status-loading"></span>
                    <span id="statusText">初始化中...</span>
                </span>
            </div>
            <div class="info-row">
                <span class="label">RHI 后端:</span>
                <span class="value" id="rhiBackend">-</span>
            </div>
            <div class="info-row">
                <span class="label">设备:</span>
                <span class="value" id="deviceName">-</span>
            </div>
            <div class="info-row">
                <span class="label">供应商:</span>
                <span class="value" id="vendorName">-</span>
            </div>
            <div class="info-row">
                <span class="label">着色器版本:</span>
                <span class="value" id="shaderVersion">-</span>
            </div>
            <div class="info-row">
                <span class="label">最大纹理尺寸:</span>
                <span class="value" id="maxTextureSize">-</span>
            </div>
            <div class="info-row">
                <span class="label">FPS:</span>
                <span class="value" id="fpsCounter">0</span>
            </div>
        </div>

        <div id="outputPanel" class="code-output" style="display: none;"></div>
        <div id="errorPanel" style="display: none;"></div>
    </div>

    <script type="module">
        // 导入 Core 包组件进行完整渲染测试
        import { WebGLDevice } from '../../rhi/src/webgl/GLDevice.js';
        import { RenderTest } from '../src/renderer/render-test.js';
        import { RHIBackend } from '../src/interface/rhi/types/enums.js';

        class WebGLRenderDemo {
            constructor() {
                this.canvas = null;
                this.rhiDevice = null;
                this.renderTest = null;
                this.isRendering = false;
                this.frameCount = 0;
                this.lastTime = 0;
                this.animationId = null;
                this.deviceInfo = null;
                this.coreInitialized = false;
            }

            async init() {
                try {
                    this.updateStatus('loading', '初始化 WebGL 设备...');
                    
                    // 获取画布
                    this.canvas = document.getElementById('webglCanvas');
                    if (!this.canvas) {
                        throw new Error('无法找到画布元素');
                    }

                    // 设置画布尺寸
                    this.resizeCanvas();
                    window.addEventListener('resize', () => this.resizeCanvas());

                    // 创建 RHI WebGL 设备
                    this.initRHIDevice();

                    // 初始化 Core 渲染测试
                    await this.initCoreRenderer();

                    // 更新界面显示
                    this.updateDeviceInfo();
                    this.updateStatus('ready', 'Core 渲染系统初始化成功');

                    // 开始渲染循环
                    this.startRender();

                } catch (error) {
                    this.handleError(error);
                }
            }

            initRHIDevice() {
                // 创建 RHI WebGL 设备
                this.rhiDevice = new WebGLDevice(this.canvas, {
                    antialias: true,
                    alpha: true,
                    depth: true,
                    stencil: false,
                    powerPreference: 'high-performance'
                });

                // 收集设备信息
                this.collectDeviceInfo();
            }

            async initCoreRenderer() {
                if (!this.rhiDevice) {
                    throw new Error('RHI 设备尚未初始化');
                }

                // 创建 Core 渲染测试实例
                this.renderTest = new RenderTest(this.rhiDevice);
                
                // 初始化测试场景
                this.renderTest.initializeTestScene();
                
                this.coreInitialized = true;
            }

            collectDeviceInfo() {
                if (!this.rhiDevice) return;

                // 从 RHI 设备获取信息
                this.deviceInfo = this.rhiDevice.getInfo();
                
                // 同时获取原生 WebGL 信息用于详细分析
                const gl = this.rhiDevice.getGL();
                this.deviceInfo.nativeGL = {
                    vendor: gl.getParameter(gl.VENDOR),
                    renderer: gl.getParameter(gl.RENDERER),
                    version: gl.getParameter(gl.VERSION),
                    extensions: gl.getSupportedExtensions(),
                    contextAttributes: gl.getContextAttributes()
                };
            }

            resizeCanvas() {
                const container = this.canvas.parentElement;
                const rect = container.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';

                if (this.rhiDevice) {
                    const gl = this.rhiDevice.getGL();
                    gl.viewport(0, 0, this.canvas.width, this.canvas.height);
                }
            }

            updateDeviceInfo() {
                if (!this.deviceInfo) return;

                document.getElementById('rhiBackend').textContent = 
                    this.deviceInfo.backend === RHIBackend.WebGL2 ? 'WebGL 2.0' : 'WebGL 1.0';
                document.getElementById('deviceName').textContent = this.deviceInfo.deviceName || '未知';
                document.getElementById('vendorName').textContent = this.deviceInfo.vendorName || '未知';
                document.getElementById('shaderVersion').textContent = this.deviceInfo.shaderLanguageVersion || '未知';
                document.getElementById('maxTextureSize').textContent = this.deviceInfo.maxTextureSize || '未知';
            }

            updateStatus(type, text) {
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                indicator.className = `status-indicator status-${type}`;
                statusText.textContent = text;
            }

            handleError(error) {
                console.error('WebGL 渲染演示错误:', error);
                this.updateStatus('error', `错误: ${error.message}`);
                
                const errorPanel = document.getElementById('errorPanel');
                errorPanel.innerHTML = `
                    <div class="error">
                        <strong>渲染错误:</strong> ${error.message}
                        <br><br>
                        <strong>可能的解决方案:</strong>
                        <ul>
                            <li>确保浏览器支持 WebGL</li>
                            <li>检查显卡驱动是否最新</li>
                            <li>尝试在浏览器中启用硬件加速</li>
                            <li>清除浏览器缓存并重新加载页面</li>
                        </ul>
                    </div>
                `;
                errorPanel.style.display = 'block';
            }

            startRender() {
                if (this.isRendering) return;
                
                this.isRendering = true;
                this.lastTime = performance.now();
                this.frameCount = 0;
                this.render();
            }

            stopRender() {
                this.isRendering = false;
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            }

            render() {
                if (!this.isRendering || !this.rhiDevice) return;

                const currentTime = performance.now();
                const deltaTime = currentTime - this.lastTime;

                try {
                    // 使用 RHI 设备进行渲染
                    const gl = this.rhiDevice.getGL();
                    gl.viewport(0, 0, this.canvas.width, this.canvas.height);
                    
                    // 使用动态颜色清屏
                    const time = currentTime * 0.001;
                    const r = Math.sin(time * 0.3) * 0.3 + 0.1;
                    const g = Math.sin(time * 0.5) * 0.3 + 0.2;
                    const b = Math.sin(time * 0.7) * 0.3 + 0.4;
                    
                    gl.clearColor(r, g, b, 1.0);
                    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

                    // 更新 FPS
                    this.frameCount++;
                    if (deltaTime >= 1000) {
                        const fps = Math.round((this.frameCount * 1000) / deltaTime);
                        document.getElementById('fpsCounter').textContent = fps;
                        this.frameCount = 0;
                        this.lastTime = currentTime;
                    }

                } catch (error) {
                    this.handleError(error);
                    return;
                }

                this.animationId = requestAnimationFrame(() => this.render());
            }

            clearCanvas() {
                if (!this.rhiDevice) return;

                try {
                    const gl = this.rhiDevice.getGL();
                    gl.clearColor(0.0, 0.0, 0.0, 1.0);
                    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                } catch (error) {
                    this.handleError(error);
                }
            }

            testCoreRenderer() {
                if (!this.coreInitialized) {
                    alert('Core 渲染器尚未初始化，请稍等...');
                    return;
                }

                try {
                    this.updateStatus('testing', '测试 Core 渲染管线...');
                    
                    // 执行 Core 渲染测试
                    const success = this.renderTest.executeRenderTest();
                    
                    if (success) {
                        this.updateStatus('ready', 'Core 渲染测试成功！');
                        
                        // 获取渲染统计
                        const stats = this.renderTest.renderer?.getStatistics();
                        if (stats) {
                            alert(`🎉 Core 渲染测试成功！

渲染统计信息:
• 绘制调用: ${stats.drawCalls}
• 三角形数: ${stats.triangles}
• 顶点数: ${stats.vertices}
• 对象数: ${stats.objects}
• 帧时间: ${stats.frameTime.toFixed(2)}ms
• FPS: ${stats.fps}

这证明 Core 包的完整渲染管线正常工作！
包括: Scene → GameObject → Material → Geometry → Renderer`);
                        } else {
                            alert('🎉 Core 渲染测试成功！\n\n完整的渲染管线已验证正常工作。');
                        }
                    } else {
                        this.updateStatus('error', 'Core 渲染测试失败');
                        alert('❌ Core 渲染测试失败\n\n请检查控制台错误信息');
                    }
                } catch (error) {
                    this.handleError(error);
                    alert(`❌ Core 渲染测试异常: ${error.message}`);
                }
            }

            renderColorfulBackground() {
                if (!this.gl) return;

                try {
                    const colors = [
                        [1.0, 0.0, 0.0, 1.0], // 红色
                        [0.0, 1.0, 0.0, 1.0], // 绿色
                        [0.0, 0.0, 1.0, 1.0], // 蓝色
                        [1.0, 1.0, 0.0, 1.0], // 黄色
                        [1.0, 0.0, 1.0, 1.0], // 紫色
                    ];
                    
                    const randomColor = colors[Math.floor(Math.random() * colors.length)];
                    this.gl.clearColor(...randomColor);
                    this.gl.clear(this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT);
                    
                    this.updateStatus('ready', `设置背景颜色为 RGBA(${randomColor.map(v => Math.round(v*255)).join(', ')})`);
                } catch (error) {
                    this.handleError(error);
                }
            }

            showDeviceInfo() {
                if (!this.deviceInfo) {
                    alert('设备信息尚未收集');
                    return;
                }

                const info = this.deviceInfo;
                const nativeGL = info.nativeGL || {};
                const isWebGL2 = info.backend === RHIBackend.WebGL2;
                
                const details = `Maxellabs Core 渲染系统信息:

🎮 Core 系统状态:
• RHI 后端: ${isWebGL2 ? 'WebGL 2.0' : 'WebGL 1.0'}
• Core 渲染器: ${this.coreInitialized ? '✅ 已初始化' : '❌ 未初始化'}
• 渲染测试: ${this.renderTest ? '✅ 可用' : '❌ 不可用'}

🔧 基本信息:
• 设备名称: ${info.deviceName}
• 供应商: ${info.vendorName}
• 着色器版本: ${info.shaderLanguageVersion}
• 最大纹理尺寸: ${info.maxTextureSize}

🎯 RHI 功能特性:
• 支持各向异性过滤: ${info.supportsAnisotropy ? '✅' : '❌'}
• 支持多重采样: ${info.supportsMSAA ? '✅' : '❌'}
• 最大采样数: ${info.maxSampleCount}
• 最大绑定数: ${info.maxBindings}

📊 原生 WebGL 信息:
• 渲染器: ${nativeGL.renderer || '未知'}
• 供应商: ${nativeGL.vendor || '未知'}
• 版本: ${nativeGL.version || '未知'}

🔌 支持的扩展: ${nativeGL.extensions?.length || 0} 个`;

                alert(details);
            }

            checkExtensions() {
                if (!this.deviceInfo) {
                    alert('设备信息尚未收集');
                    return;
                }

                const extensions = this.deviceInfo.nativeGL?.extensions || [];
                alert(`支持的 WebGL 扩展 (${extensions.length} 个):\n\n${extensions.sort().join('\n')}`);
            }

            showRHICapabilities() {
                if (!this.deviceInfo) {
                    alert('设备信息尚未收集');
                    return;
                }

                const extensions = this.deviceInfo.nativeGL?.extensions || [];
                const isWebGL2 = this.deviceInfo.backend === RHIBackend.WebGL2;
                
                const capabilities = {
                    depthTexture: extensions.includes('WEBGL_depth_texture'),
                    textureFloat: extensions.includes('OES_texture_float'),
                    textureHalfFloat: extensions.includes('OES_texture_half_float'),
                    anisotropicFiltering: extensions.includes('EXT_texture_filter_anisotropic'),
                    vertexArrayObject: extensions.includes('OES_vertex_array_object') || isWebGL2,
                    instancedArrays: extensions.includes('ANGLE_instanced_arrays') || isWebGL2,
                    multipleRenderTargets: extensions.includes('WEBGL_draw_buffers') || isWebGL2,
                    standardDerivatives: extensions.includes('OES_standard_derivatives') || isWebGL2,
                };

                const capabilityText = Object.entries(capabilities)
                    .map(([key, value]) => `• ${key}: ${value ? '✅ 支持' : '❌ 不支持'}`)
                    .join('\n');

                alert(`RHI 硬件抽象层能力检测:\n\n${capabilityText}`);
            }

            logToConsole() {
                console.group('🎮 Maxellabs WebGL RHI 设备信息');
                console.log('设备信息:', this.deviceInfo);
                console.log('RHI 设备:', this.rhiDevice);
                console.log('Core 渲染测试:', this.renderTest);
                console.log('画布:', this.canvas);
                console.groupEnd();
                
                this.updateStatus('ready', '设备信息已输出到控制台');
            }

            exportDeviceInfo() {
                if (!this.deviceInfo) {
                    alert('设备信息尚未收集');
                    return;
                }

                const exportData = {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    webglInfo: this.deviceInfo,
                    canvasSize: {
                        width: this.canvas.width,
                        height: this.canvas.height,
                        devicePixelRatio: window.devicePixelRatio
                    }
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `webgl-device-info-${Date.now()}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                this.updateStatus('ready', '设备信息已导出为 JSON 文件');
            }

            testWebGLFeatures() {
                if (!this.rhiDevice) return;
                
                const gl = this.rhiDevice.getGL();

                const output = document.getElementById('outputPanel');
                output.style.display = 'block';
                
                let testResults = '🧪 WebGL 功能测试结果:\n\n';
                
                try {
                    // 测试缓冲区创建
                    const buffer = gl.createBuffer();
                    testResults += `✅ 缓冲区创建: 成功\n`;
                    gl.deleteBuffer(buffer);
                    
                    // 测试纹理创建
                    const texture = gl.createTexture();
                    testResults += `✅ 纹理创建: 成功\n`;
                    gl.deleteTexture(texture);
                    
                    // 测试着色器编译
                    const vertexShader = gl.createShader(gl.VERTEX_SHADER);
                    const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
                    testResults += `✅ 着色器创建: 成功\n`;
                    gl.deleteShader(vertexShader);
                    gl.deleteShader(fragmentShader);
                    
                    // 测试渲染缓冲区
                    const renderbuffer = gl.createRenderbuffer();
                    testResults += `✅ 渲染缓冲区创建: 成功\n`;
                    gl.deleteRenderbuffer(renderbuffer);
                    
                    // 测试帧缓冲区
                    const framebuffer = gl.createFramebuffer();
                    testResults += `✅ 帧缓冲区创建: 成功\n`;
                    gl.deleteFramebuffer(framebuffer);
                    
                    // 测试 RHI 设备功能
                    testResults += `✅ RHI 设备: ${this.deviceInfo.backend === RHIBackend.WebGL2 ? 'WebGL2' : 'WebGL1'}\n`;
                    testResults += `✅ Core 渲染器: ${this.coreInitialized ? '已初始化' : '未初始化'}\n`;
                    
                } catch (error) {
                    testResults += `❌ 测试失败: ${error.message}\n`;
                }
                
                output.textContent = testResults;
                this.updateStatus('ready', 'WebGL 功能测试完成');
            }

            measurePerformance() {
                if (!this.rhiDevice) return;
                
                const gl = this.rhiDevice.getGL();

                const output = document.getElementById('outputPanel');
                output.style.display = 'block';
                
                let perfResults = '⚡ WebGL 性能测试:\n\n';
                const startTime = performance.now();
                
                try {
                    // 绘制调用性能测试
                    const iterations = 1000;
                    
                    perfResults += `测试 ${iterations} 次清屏操作...\n`;
                    const clearStart = performance.now();
                    
                    for (let i = 0; i < iterations; i++) {
                        gl.clearColor(Math.random(), Math.random(), Math.random(), 1.0);
                        gl.clear(gl.COLOR_BUFFER_BIT);
                    }
                    
                    const clearEnd = performance.now();
                    const clearTime = clearEnd - clearStart;
                    
                    perfResults += `清屏操作总耗时: ${clearTime.toFixed(2)}ms\n`;
                    perfResults += `平均每次清屏: ${(clearTime / iterations).toFixed(4)}ms\n`;
                    perfResults += `理论最大清屏FPS: ${(1000 / (clearTime / iterations)).toFixed(0)}\n\n`;
                    
                    // 上下文状态切换测试
                    perfResults += `测试上下文状态切换...\n`;
                    const stateStart = performance.now();
                    
                    for (let i = 0; i < iterations; i++) {
                        gl.enable(gl.DEPTH_TEST);
                        gl.disable(gl.DEPTH_TEST);
                        gl.enable(gl.BLEND);
                        gl.disable(gl.BLEND);
                    }
                    
                    const stateEnd = performance.now();
                    const stateTime = stateEnd - stateStart;
                    
                    perfResults += `状态切换总耗时: ${stateTime.toFixed(2)}ms\n`;
                    perfResults += `平均每次状态切换: ${(stateTime / (iterations * 4)).toFixed(4)}ms\n\n`;
                    
                    const totalTime = performance.now() - startTime;
                    perfResults += `总测试时间: ${totalTime.toFixed(2)}ms\n`;
                    
                } catch (error) {
                    perfResults += `❌ 性能测试失败: ${error.message}\n`;
                }
                
                output.textContent = perfResults;
                this.updateStatus('ready', 'WebGL 性能测试完成');
            }
        }

        // 创建全局演示实例
        window.demo = new WebGLRenderDemo();

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            window.demo.init();
        });
    </script>
</body>
</html> 