<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maxellabs 3D Engine - Core æ¸²æŸ“ç®¡çº¿æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .demo-section {
            margin-bottom: 30px;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 2px solid #34495e;
        }

        #renderCanvas {
            width: 100%;
            height: 500px;
            display: block;
            background: #000;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .control-group h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
            width: calc(100% - 10px);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        button.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .info-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .label {
            font-weight: bold;
            color: #495057;
        }

        .value {
            color: #6c757d;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ready { background: #27ae60; }
        .status-error { background: #e74c3c; }
        .status-loading { background: #f39c12; }
        .status-testing { background: #3498db; }

        .test-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #34495e;
        }

        .test-success {
            color: #2ecc71;
        }

        .test-error {
            color: #e74c3c;
        }

        .test-warning {
            color: #f39c12;
        }

        .error {
            background: #fdf2f2;
            color: #e53e3e;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #feb2b2;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Maxellabs 3D Engine</h1>
        <div class="subtitle">Core æ¸²æŸ“ç®¡çº¿å®Œæ•´æ€§æµ‹è¯•</div>
        
        <div class="demo-section">
            <div class="canvas-container">
                <canvas id="renderCanvas"></canvas>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>ğŸ”§ Core ç³»ç»Ÿæµ‹è¯•</h3>
                <button onclick="demo.initializeCoreRenderer()">åˆå§‹åŒ– Core æ¸²æŸ“å™¨</button>
                <button onclick="demo.testRenderPipeline()">æµ‹è¯•æ¸²æŸ“ç®¡çº¿</button>
                <button onclick="demo.runFullRenderTest()">è¿è¡Œå®Œæ•´æ¸²æŸ“æµ‹è¯•</button>
                <button onclick="demo.testSceneSystem()" class="success">æµ‹è¯•åœºæ™¯ç³»ç»Ÿ</button>
            </div>

            <div class="control-group">
                <h3>ğŸ¨ ç»„ä»¶æµ‹è¯•</h3>
                <button onclick="demo.testGeometrySystem()">æµ‹è¯•å‡ ä½•ä½“ç³»ç»Ÿ</button>
                <button onclick="demo.testMaterialSystem()">æµ‹è¯•æè´¨ç³»ç»Ÿ</button>
                <button onclick="demo.testCameraSystem()">æµ‹è¯•ç›¸æœºç³»ç»Ÿ</button>
                <button onclick="demo.testTransformSystem()">æµ‹è¯•å˜æ¢ç³»ç»Ÿ</button>
            </div>

            <div class="control-group">
                <h3>ğŸ¯ æ¸²æŸ“æ¨¡å¼</h3>
                <button onclick="demo.renderTestCube()">æ¸²æŸ“æµ‹è¯•ç«‹æ–¹ä½“</button>
                <button onclick="demo.toggleWireframe()">åˆ‡æ¢çº¿æ¡†æ¨¡å¼</button>
                <button onclick="demo.changeBackgroundColor()">æ›´æ¢èƒŒæ™¯è‰²</button>
                <button onclick="demo.resetCamera()">é‡ç½®ç›¸æœº</button>
            </div>

            <div class="control-group">
                <h3>ğŸ“Š æ€§èƒ½åˆ†æ</h3>
                <button onclick="demo.showRenderStatistics()">æ˜¾ç¤ºæ¸²æŸ“ç»Ÿè®¡</button>
                <button onclick="demo.profileRenderTime()">åˆ†ææ¸²æŸ“æ—¶é—´</button>
                <button onclick="demo.memoryUsageAnalysis()">å†…å­˜ä½¿ç”¨åˆ†æ</button>
                <button onclick="demo.exportTestReport()" class="danger">å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š</button>
            </div>
        </div>

        <div id="infoPanel" class="info-panel">
            <div class="info-row">
                <span class="label">ç³»ç»ŸçŠ¶æ€:</span>
                <span class="value">
                    <span id="statusIndicator" class="status-indicator status-loading"></span>
                    <span id="statusText">æ­£åœ¨åˆå§‹åŒ–...</span>
                </span>
            </div>
            <div class="info-row">
                <span class="label">RHI è®¾å¤‡:</span>
                <span class="value" id="rhiDevice">-</span>
            </div>
            <div class="info-row">
                <span class="label">æ¸²æŸ“å™¨:</span>
                <span class="value" id="renderer">-</span>
            </div>
            <div class="info-row">
                <span class="label">åœºæ™¯å¯¹è±¡æ•°:</span>
                <span class="value" id="sceneObjects">0</span>
            </div>
            <div class="info-row">
                <span class="label">ç»˜åˆ¶è°ƒç”¨:</span>
                <span class="value" id="drawCalls">0</span>
            </div>
            <div class="info-row">
                <span class="label">ä¸‰è§’å½¢æ•°:</span>
                <span class="value" id="triangles">0</span>
            </div>
            <div class="info-row">
                <span class="label">FPS:</span>
                <span class="value" id="fps">0</span>
            </div>
            <div class="info-row">
                <span class="label">æµ‹è¯•è¿›åº¦:</span>
                <span class="value">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <span id="progressText">0%</span>
                </span>
            </div>
        </div>

        <div id="testOutput" class="test-output" style="display: none;"></div>
        <div id="errorPanel" style="display: none;"></div>
    </div>

    <script type="module">
        // å¯¼å…¥ Core åŒ…ç»„ä»¶
        import { WebGLDevice } from '../../rhi/src/webgl/GLDevice.js';
        import { RenderTest } from '../src/renderer/render-test.js';
        import { RHIBackend } from '../src/interface/rhi/types/enums.js';

        class CoreRenderTestDemo {
            constructor() {
                this.canvas = null;
                this.rhiDevice = null;
                this.renderTest = null;
                this.isInitialized = false;
                this.testResults = [];
                this.currentProgress = 0;
                this.maxProgress = 100;
            }

            async init() {
                try {
                    this.updateStatus('loading', 'åˆå§‹åŒ– Core æ¸²æŸ“ç³»ç»Ÿ...');
                    this.log('ğŸš€ å¼€å§‹åˆå§‹åŒ– Maxellabs 3D Engine Core æ¸²æŸ“ç³»ç»Ÿ');
                    
                    // è·å–ç”»å¸ƒ
                    this.canvas = document.getElementById('renderCanvas');
                    if (!this.canvas) {
                        throw new Error('æ— æ³•æ‰¾åˆ°æ¸²æŸ“ç”»å¸ƒ');
                    }

                    // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                    this.resizeCanvas();
                    window.addEventListener('resize', () => this.resizeCanvas());

                    await this.initializeCoreRenderer();

                } catch (error) {
                    this.handleError(error);
                }
            }

            async initializeCoreRenderer() {
                try {
                    this.updateProgress(10, 'åˆ›å»º RHI è®¾å¤‡...');
                    
                    // åˆ›å»º RHI WebGL è®¾å¤‡
                    this.rhiDevice = new WebGLDevice(this.canvas, {
                        antialias: true,
                        alpha: false,
                        depth: true,
                        stencil: true,
                        powerPreference: 'high-performance'
                    });

                    this.log('âœ… RHI WebGL è®¾å¤‡åˆ›å»ºæˆåŠŸ');
                    this.updateProgress(30, 'åˆå§‹åŒ– Core æ¸²æŸ“æµ‹è¯•...');

                    // åˆ›å»º Core æ¸²æŸ“æµ‹è¯•å®ä¾‹
                    this.renderTest = new RenderTest(this.rhiDevice);
                    
                    this.updateProgress(50, 'æ„å»ºæµ‹è¯•åœºæ™¯...');
                    
                    // åˆå§‹åŒ–æµ‹è¯•åœºæ™¯
                    this.renderTest.initializeTestScene();
                    
                    this.updateProgress(100, 'åˆå§‹åŒ–å®Œæˆ');
                    
                    this.isInitialized = true;
                    this.updateDeviceInfo();
                    this.updateStatus('ready', 'Core æ¸²æŸ“ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');
                    this.log('ğŸ‰ Core æ¸²æŸ“ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼');

                } catch (error) {
                    this.log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }

            async testRenderPipeline() {
                if (!this.isInitialized) {
                    alert('è¯·å…ˆåˆå§‹åŒ– Core æ¸²æŸ“å™¨');
                    return;
                }

                try {
                    this.updateStatus('testing', 'æµ‹è¯•æ¸²æŸ“ç®¡çº¿...');
                    this.log('ğŸ§ª å¼€å§‹æµ‹è¯• Core æ¸²æŸ“ç®¡çº¿');

                    // æ‰§è¡Œæ¸²æŸ“æµ‹è¯•
                    const success = this.renderTest.executeRenderTest();
                    
                    if (success) {
                        this.log('âœ… æ¸²æŸ“ç®¡çº¿æµ‹è¯•æˆåŠŸï¼', 'success');
                        this.updateStatus('ready', 'æ¸²æŸ“ç®¡çº¿æµ‹è¯•é€šè¿‡');
                        
                        // è·å–æ¸²æŸ“ç»Ÿè®¡
                        const stats = this.renderTest.renderer?.getStatistics();
                        if (stats) {
                            this.updateRenderStats(stats);
                            this.log(`ğŸ“Š æ¸²æŸ“ç»Ÿè®¡: ç»˜åˆ¶è°ƒç”¨=${stats.drawCalls}, ä¸‰è§’å½¢=${stats.triangles}`, 'success');
                        }
                    } else {
                        this.log('âŒ æ¸²æŸ“ç®¡çº¿æµ‹è¯•å¤±è´¥', 'error');
                        this.updateStatus('error', 'æ¸²æŸ“ç®¡çº¿æµ‹è¯•å¤±è´¥');
                    }

                } catch (error) {
                    this.log(`âŒ æ¸²æŸ“ç®¡çº¿æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                    this.handleError(error);
                }
            }

            async runFullRenderTest() {
                if (!this.isInitialized) {
                    await this.initializeCoreRenderer();
                }

                this.updateStatus('testing', 'è¿è¡Œå®Œæ•´æ¸²æŸ“æµ‹è¯•...');
                this.log('ğŸ” å¼€å§‹è¿è¡Œå®Œæ•´ Core æ¸²æŸ“æµ‹è¯•å¥—ä»¶');

                const tests = [
                    { name: 'å‡ ä½•ä½“ç³»ç»Ÿ', fn: () => this.testGeometrySystem() },
                    { name: 'æè´¨ç³»ç»Ÿ', fn: () => this.testMaterialSystem() },
                    { name: 'ç›¸æœºç³»ç»Ÿ', fn: () => this.testCameraSystem() },
                    { name: 'åœºæ™¯ç³»ç»Ÿ', fn: () => this.testSceneSystem() },
                    { name: 'æ¸²æŸ“ç®¡çº¿', fn: () => this.testRenderPipeline() },
                ];

                let passedTests = 0;
                const totalTests = tests.length;

                for (let i = 0; i < tests.length; i++) {
                    const test = tests[i];
                    this.updateProgress(((i + 1) / totalTests) * 100, `æµ‹è¯• ${test.name}...`);
                    
                    try {
                        await test.fn();
                        passedTests++;
                        this.log(`âœ… ${test.name} æµ‹è¯•é€šè¿‡`, 'success');
                    } catch (error) {
                        this.log(`âŒ ${test.name} æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                    }
                    
                    // çŸ­æš‚å»¶è¿Ÿä»¥æ˜¾ç¤ºè¿›åº¦
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                const successRate = (passedTests / totalTests) * 100;
                this.log(`ğŸ¯ æµ‹è¯•å®Œæˆ: ${passedTests}/${totalTests} é€šè¿‡ (${successRate.toFixed(1)}%)`, 
                         successRate === 100 ? 'success' : 'warning');
                
                this.updateStatus(successRate === 100 ? 'ready' : 'error', 
                                `æµ‹è¯•å®Œæˆ: ${passedTests}/${totalTests} é€šè¿‡`);
            }

            testGeometrySystem() {
                this.log('ğŸ”º æµ‹è¯•å‡ ä½•ä½“ç³»ç»Ÿ...');
                // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„å‡ ä½•ä½“æµ‹è¯•é€»è¾‘
                return Promise.resolve();
            }

            testMaterialSystem() {
                this.log('ğŸ¨ æµ‹è¯•æè´¨ç³»ç»Ÿ...');
                // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„æè´¨æµ‹è¯•é€»è¾‘
                return Promise.resolve();
            }

            testCameraSystem() {
                this.log('ğŸ“· æµ‹è¯•ç›¸æœºç³»ç»Ÿ...');
                // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„ç›¸æœºæµ‹è¯•é€»è¾‘
                return Promise.resolve();
            }

            testSceneSystem() {
                this.log('ğŸŒ æµ‹è¯•åœºæ™¯ç³»ç»Ÿ...');
                // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„åœºæ™¯æµ‹è¯•é€»è¾‘
                return Promise.resolve();
            }

            testTransformSystem() {
                this.log('ğŸ”„ æµ‹è¯•å˜æ¢ç³»ç»Ÿ...');
                // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„å˜æ¢æµ‹è¯•é€»è¾‘
                return Promise.resolve();
            }

            renderTestCube() {
                if (!this.isInitialized) {
                    alert('è¯·å…ˆåˆå§‹åŒ– Core æ¸²æŸ“å™¨');
                    return;
                }

                this.log('ğŸ² æ¸²æŸ“æµ‹è¯•ç«‹æ–¹ä½“...');
                this.testRenderPipeline();
            }

            toggleWireframe() {
                this.log('ğŸ“ åˆ‡æ¢çº¿æ¡†æ¨¡å¼ (åŠŸèƒ½å¼€å‘ä¸­...)');
            }

            changeBackgroundColor() {
                this.log('ğŸ¨ æ›´æ¢èƒŒæ™¯è‰² (åŠŸèƒ½å¼€å‘ä¸­...)');
            }

            resetCamera() {
                this.log('ğŸ“· é‡ç½®ç›¸æœº (åŠŸèƒ½å¼€å‘ä¸­...)');
            }

            showRenderStatistics() {
                if (!this.renderTest?.renderer) {
                    alert('æ¸²æŸ“å™¨å°šæœªåˆå§‹åŒ–');
                    return;
                }

                const stats = this.renderTest.renderer.getStatistics();
                alert(`æ¸²æŸ“ç»Ÿè®¡ä¿¡æ¯:

ğŸ¯ ç»˜åˆ¶è°ƒç”¨: ${stats.drawCalls}
ğŸ”º ä¸‰è§’å½¢æ•°: ${stats.triangles}
ğŸ“ é¡¶ç‚¹æ•°: ${stats.vertices}
ğŸ“¦ å¯¹è±¡æ•°: ${stats.objects}
â±ï¸ å¸§æ—¶é—´: ${stats.frameTime.toFixed(2)}ms
ğŸ® FPS: ${stats.fps}`);
            }

            profileRenderTime() {
                this.log('â±ï¸ åˆ†ææ¸²æŸ“æ—¶é—´ (åŠŸèƒ½å¼€å‘ä¸­...)');
            }

            memoryUsageAnalysis() {
                this.log('ğŸ’¾ å†…å­˜ä½¿ç”¨åˆ†æ (åŠŸèƒ½å¼€å‘ä¸­...)');
            }

            exportTestReport() {
                const report = {
                    timestamp: new Date().toISOString(),
                    engine: 'Maxellabs 3D Engine',
                    version: '0.0.1',
                    testResults: this.testResults,
                    deviceInfo: this.rhiDevice?.getInfo(),
                    isInitialized: this.isInitialized
                };

                const reportStr = JSON.stringify(report, null, 2);
                const blob = new Blob([reportStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `core-render-test-${Date.now()}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                this.log('ğŸ“„ æµ‹è¯•æŠ¥å‘Šå·²å¯¼å‡º');
            }

            resizeCanvas() {
                const container = this.canvas.parentElement;
                const rect = container.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';
            }

            updateDeviceInfo() {
                if (!this.rhiDevice) return;

                const info = this.rhiDevice.getInfo();
                document.getElementById('rhiDevice').textContent = 
                    info.backend === RHIBackend.WebGL2 ? 'WebGL 2.0' : 'WebGL 1.0';
                document.getElementById('renderer').textContent = 'ForwardRenderer';
            }

            updateRenderStats(stats) {
                document.getElementById('drawCalls').textContent = stats.drawCalls || 0;
                document.getElementById('triangles').textContent = stats.triangles || 0;
                document.getElementById('fps').textContent = stats.fps || 0;
            }

            updateStatus(type, text) {
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                indicator.className = `status-indicator status-${type}`;
                statusText.textContent = text;
            }

            updateProgress(percent, text) {
                this.currentProgress = Math.min(percent, this.maxProgress);
                document.getElementById('progressFill').style.width = `${this.currentProgress}%`;
                document.getElementById('progressText').textContent = `${Math.round(this.currentProgress)}%`;
                
                if (text) {
                    this.updateStatus('testing', text);
                }
            }

            log(message, type = 'info') {
                const output = document.getElementById('testOutput');
                output.style.display = 'block';
                
                const timestamp = new Date().toLocaleTimeString();
                const className = `test-${type}`;
                
                output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
                output.scrollTop = output.scrollHeight;
                
                // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
                console.log(`[Core Test] ${message}`);
                
                // è®°å½•æµ‹è¯•ç»“æœ
                this.testResults.push({
                    timestamp,
                    message,
                    type
                });
            }

            handleError(error) {
                console.error('Core æ¸²æŸ“æµ‹è¯•é”™è¯¯:', error);
                this.updateStatus('error', `é”™è¯¯: ${error.message}`);
                this.log(`âŒ ç³»ç»Ÿé”™è¯¯: ${error.message}`, 'error');
                
                const errorPanel = document.getElementById('errorPanel');
                errorPanel.innerHTML = `
                    <div class="error">
                        <strong>Core æ¸²æŸ“ç³»ç»Ÿé”™è¯¯:</strong> ${error.message}
                        <br><br>
                        <strong>å¯èƒ½çš„åŸå› :</strong>
                        <ul>
                            <li>RHI è®¾å¤‡åˆå§‹åŒ–å¤±è´¥</li>
                            <li>Core ç»„ä»¶ä¾èµ–ç¼ºå¤±</li>
                            <li>WebGL ä¸Šä¸‹æ–‡åˆ›å»ºå¤±è´¥</li>
                            <li>ç€è‰²å™¨ç¼–è¯‘æˆ–é“¾æ¥é”™è¯¯</li>
                        </ul>
                    </div>
                `;
                errorPanel.style.display = 'block';
            }
        }

        // åˆ›å»ºå…¨å±€æ¼”ç¤ºå®ä¾‹
        window.demo = new CoreRenderTestDemo();

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.demo.init();
        });
    </script>
</body>
</html> 