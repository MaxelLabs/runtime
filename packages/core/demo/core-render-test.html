<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maxellabs 3D Engine - Core 渲染管线测试</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .demo-section {
            margin-bottom: 30px;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 2px solid #34495e;
        }

        #renderCanvas {
            width: 100%;
            height: 500px;
            display: block;
            background: #000;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .control-group h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
            width: calc(100% - 10px);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        button.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .info-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .label {
            font-weight: bold;
            color: #495057;
        }

        .value {
            color: #6c757d;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ready { background: #27ae60; }
        .status-error { background: #e74c3c; }
        .status-loading { background: #f39c12; }
        .status-testing { background: #3498db; }

        .test-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #34495e;
        }

        .test-success {
            color: #2ecc71;
        }

        .test-error {
            color: #e74c3c;
        }

        .test-warning {
            color: #f39c12;
        }

        .error {
            background: #fdf2f2;
            color: #e53e3e;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #feb2b2;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Maxellabs 3D Engine</h1>
        <div class="subtitle">Core 渲染管线完整性测试</div>
        
        <div class="demo-section">
            <div class="canvas-container">
                <canvas id="renderCanvas"></canvas>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>🔧 Core 系统测试</h3>
                <button onclick="demo.initializeCoreRenderer()">初始化 Core 渲染器</button>
                <button onclick="demo.testRenderPipeline()">测试渲染管线</button>
                <button onclick="demo.runFullRenderTest()">运行完整渲染测试</button>
                <button onclick="demo.testSceneSystem()" class="success">测试场景系统</button>
            </div>

            <div class="control-group">
                <h3>🎨 组件测试</h3>
                <button onclick="demo.testGeometrySystem()">测试几何体系统</button>
                <button onclick="demo.testMaterialSystem()">测试材质系统</button>
                <button onclick="demo.testCameraSystem()">测试相机系统</button>
                <button onclick="demo.testTransformSystem()">测试变换系统</button>
            </div>

            <div class="control-group">
                <h3>🎯 渲染模式</h3>
                <button onclick="demo.renderTestCube()">渲染测试立方体</button>
                <button onclick="demo.toggleWireframe()">切换线框模式</button>
                <button onclick="demo.changeBackgroundColor()">更换背景色</button>
                <button onclick="demo.resetCamera()">重置相机</button>
            </div>

            <div class="control-group">
                <h3>📊 性能分析</h3>
                <button onclick="demo.showRenderStatistics()">显示渲染统计</button>
                <button onclick="demo.profileRenderTime()">分析渲染时间</button>
                <button onclick="demo.memoryUsageAnalysis()">内存使用分析</button>
                <button onclick="demo.exportTestReport()" class="danger">导出测试报告</button>
            </div>
        </div>

        <div id="infoPanel" class="info-panel">
            <div class="info-row">
                <span class="label">系统状态:</span>
                <span class="value">
                    <span id="statusIndicator" class="status-indicator status-loading"></span>
                    <span id="statusText">正在初始化...</span>
                </span>
            </div>
            <div class="info-row">
                <span class="label">RHI 设备:</span>
                <span class="value" id="rhiDevice">-</span>
            </div>
            <div class="info-row">
                <span class="label">渲染器:</span>
                <span class="value" id="renderer">-</span>
            </div>
            <div class="info-row">
                <span class="label">场景对象数:</span>
                <span class="value" id="sceneObjects">0</span>
            </div>
            <div class="info-row">
                <span class="label">绘制调用:</span>
                <span class="value" id="drawCalls">0</span>
            </div>
            <div class="info-row">
                <span class="label">三角形数:</span>
                <span class="value" id="triangles">0</span>
            </div>
            <div class="info-row">
                <span class="label">FPS:</span>
                <span class="value" id="fps">0</span>
            </div>
            <div class="info-row">
                <span class="label">测试进度:</span>
                <span class="value">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <span id="progressText">0%</span>
                </span>
            </div>
        </div>

        <div id="testOutput" class="test-output" style="display: none;"></div>
        <div id="errorPanel" style="display: none;"></div>
    </div>

    <script type="module">
        // 导入 Core 包组件
        import { WebGLDevice } from '../../rhi/src/webgl/GLDevice.js';
        import { RenderTest } from '../src/renderer/render-test.js';
        import { RHIBackend } from '../src/interface/rhi/types/enums.js';

        class CoreRenderTestDemo {
            constructor() {
                this.canvas = null;
                this.rhiDevice = null;
                this.renderTest = null;
                this.isInitialized = false;
                this.testResults = [];
                this.currentProgress = 0;
                this.maxProgress = 100;
            }

            async init() {
                try {
                    this.updateStatus('loading', '初始化 Core 渲染系统...');
                    this.log('🚀 开始初始化 Maxellabs 3D Engine Core 渲染系统');
                    
                    // 获取画布
                    this.canvas = document.getElementById('renderCanvas');
                    if (!this.canvas) {
                        throw new Error('无法找到渲染画布');
                    }

                    // 设置画布尺寸
                    this.resizeCanvas();
                    window.addEventListener('resize', () => this.resizeCanvas());

                    await this.initializeCoreRenderer();

                } catch (error) {
                    this.handleError(error);
                }
            }

            async initializeCoreRenderer() {
                try {
                    this.updateProgress(10, '创建 RHI 设备...');
                    
                    // 创建 RHI WebGL 设备
                    this.rhiDevice = new WebGLDevice(this.canvas, {
                        antialias: true,
                        alpha: false,
                        depth: true,
                        stencil: true,
                        powerPreference: 'high-performance'
                    });

                    this.log('✅ RHI WebGL 设备创建成功');
                    this.updateProgress(30, '初始化 Core 渲染测试...');

                    // 创建 Core 渲染测试实例
                    this.renderTest = new RenderTest(this.rhiDevice);
                    
                    this.updateProgress(50, '构建测试场景...');
                    
                    // 初始化测试场景
                    this.renderTest.initializeTestScene();
                    
                    this.updateProgress(100, '初始化完成');
                    
                    this.isInitialized = true;
                    this.updateDeviceInfo();
                    this.updateStatus('ready', 'Core 渲染系统初始化成功');
                    this.log('🎉 Core 渲染系统初始化完成！');

                } catch (error) {
                    this.log(`❌ 初始化失败: ${error.message}`, 'error');
                    throw error;
                }
            }

            async testRenderPipeline() {
                if (!this.isInitialized) {
                    alert('请先初始化 Core 渲染器');
                    return;
                }

                try {
                    this.updateStatus('testing', '测试渲染管线...');
                    this.log('🧪 开始测试 Core 渲染管线');

                    // 执行渲染测试
                    const success = this.renderTest.executeRenderTest();
                    
                    if (success) {
                        this.log('✅ 渲染管线测试成功！', 'success');
                        this.updateStatus('ready', '渲染管线测试通过');
                        
                        // 获取渲染统计
                        const stats = this.renderTest.renderer?.getStatistics();
                        if (stats) {
                            this.updateRenderStats(stats);
                            this.log(`📊 渲染统计: 绘制调用=${stats.drawCalls}, 三角形=${stats.triangles}`, 'success');
                        }
                    } else {
                        this.log('❌ 渲染管线测试失败', 'error');
                        this.updateStatus('error', '渲染管线测试失败');
                    }

                } catch (error) {
                    this.log(`❌ 渲染管线测试异常: ${error.message}`, 'error');
                    this.handleError(error);
                }
            }

            async runFullRenderTest() {
                if (!this.isInitialized) {
                    await this.initializeCoreRenderer();
                }

                this.updateStatus('testing', '运行完整渲染测试...');
                this.log('🔍 开始运行完整 Core 渲染测试套件');

                const tests = [
                    { name: '几何体系统', fn: () => this.testGeometrySystem() },
                    { name: '材质系统', fn: () => this.testMaterialSystem() },
                    { name: '相机系统', fn: () => this.testCameraSystem() },
                    { name: '场景系统', fn: () => this.testSceneSystem() },
                    { name: '渲染管线', fn: () => this.testRenderPipeline() },
                ];

                let passedTests = 0;
                const totalTests = tests.length;

                for (let i = 0; i < tests.length; i++) {
                    const test = tests[i];
                    this.updateProgress(((i + 1) / totalTests) * 100, `测试 ${test.name}...`);
                    
                    try {
                        await test.fn();
                        passedTests++;
                        this.log(`✅ ${test.name} 测试通过`, 'success');
                    } catch (error) {
                        this.log(`❌ ${test.name} 测试失败: ${error.message}`, 'error');
                    }
                    
                    // 短暂延迟以显示进度
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                const successRate = (passedTests / totalTests) * 100;
                this.log(`🎯 测试完成: ${passedTests}/${totalTests} 通过 (${successRate.toFixed(1)}%)`, 
                         successRate === 100 ? 'success' : 'warning');
                
                this.updateStatus(successRate === 100 ? 'ready' : 'error', 
                                `测试完成: ${passedTests}/${totalTests} 通过`);
            }

            testGeometrySystem() {
                this.log('🔺 测试几何体系统...');
                // 这里可以添加具体的几何体测试逻辑
                return Promise.resolve();
            }

            testMaterialSystem() {
                this.log('🎨 测试材质系统...');
                // 这里可以添加具体的材质测试逻辑
                return Promise.resolve();
            }

            testCameraSystem() {
                this.log('📷 测试相机系统...');
                // 这里可以添加具体的相机测试逻辑
                return Promise.resolve();
            }

            testSceneSystem() {
                this.log('🌍 测试场景系统...');
                // 这里可以添加具体的场景测试逻辑
                return Promise.resolve();
            }

            testTransformSystem() {
                this.log('🔄 测试变换系统...');
                // 这里可以添加具体的变换测试逻辑
                return Promise.resolve();
            }

            renderTestCube() {
                if (!this.isInitialized) {
                    alert('请先初始化 Core 渲染器');
                    return;
                }

                this.log('🎲 渲染测试立方体...');
                this.testRenderPipeline();
            }

            toggleWireframe() {
                this.log('📐 切换线框模式 (功能开发中...)');
            }

            changeBackgroundColor() {
                this.log('🎨 更换背景色 (功能开发中...)');
            }

            resetCamera() {
                this.log('📷 重置相机 (功能开发中...)');
            }

            showRenderStatistics() {
                if (!this.renderTest?.renderer) {
                    alert('渲染器尚未初始化');
                    return;
                }

                const stats = this.renderTest.renderer.getStatistics();
                alert(`渲染统计信息:

🎯 绘制调用: ${stats.drawCalls}
🔺 三角形数: ${stats.triangles}
📍 顶点数: ${stats.vertices}
📦 对象数: ${stats.objects}
⏱️ 帧时间: ${stats.frameTime.toFixed(2)}ms
🎮 FPS: ${stats.fps}`);
            }

            profileRenderTime() {
                this.log('⏱️ 分析渲染时间 (功能开发中...)');
            }

            memoryUsageAnalysis() {
                this.log('💾 内存使用分析 (功能开发中...)');
            }

            exportTestReport() {
                const report = {
                    timestamp: new Date().toISOString(),
                    engine: 'Maxellabs 3D Engine',
                    version: '0.0.1',
                    testResults: this.testResults,
                    deviceInfo: this.rhiDevice?.getInfo(),
                    isInitialized: this.isInitialized
                };

                const reportStr = JSON.stringify(report, null, 2);
                const blob = new Blob([reportStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `core-render-test-${Date.now()}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                this.log('📄 测试报告已导出');
            }

            resizeCanvas() {
                const container = this.canvas.parentElement;
                const rect = container.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';
            }

            updateDeviceInfo() {
                if (!this.rhiDevice) return;

                const info = this.rhiDevice.getInfo();
                document.getElementById('rhiDevice').textContent = 
                    info.backend === RHIBackend.WebGL2 ? 'WebGL 2.0' : 'WebGL 1.0';
                document.getElementById('renderer').textContent = 'ForwardRenderer';
            }

            updateRenderStats(stats) {
                document.getElementById('drawCalls').textContent = stats.drawCalls || 0;
                document.getElementById('triangles').textContent = stats.triangles || 0;
                document.getElementById('fps').textContent = stats.fps || 0;
            }

            updateStatus(type, text) {
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                indicator.className = `status-indicator status-${type}`;
                statusText.textContent = text;
            }

            updateProgress(percent, text) {
                this.currentProgress = Math.min(percent, this.maxProgress);
                document.getElementById('progressFill').style.width = `${this.currentProgress}%`;
                document.getElementById('progressText').textContent = `${Math.round(this.currentProgress)}%`;
                
                if (text) {
                    this.updateStatus('testing', text);
                }
            }

            log(message, type = 'info') {
                const output = document.getElementById('testOutput');
                output.style.display = 'block';
                
                const timestamp = new Date().toLocaleTimeString();
                const className = `test-${type}`;
                
                output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
                output.scrollTop = output.scrollHeight;
                
                // 同时输出到控制台
                console.log(`[Core Test] ${message}`);
                
                // 记录测试结果
                this.testResults.push({
                    timestamp,
                    message,
                    type
                });
            }

            handleError(error) {
                console.error('Core 渲染测试错误:', error);
                this.updateStatus('error', `错误: ${error.message}`);
                this.log(`❌ 系统错误: ${error.message}`, 'error');
                
                const errorPanel = document.getElementById('errorPanel');
                errorPanel.innerHTML = `
                    <div class="error">
                        <strong>Core 渲染系统错误:</strong> ${error.message}
                        <br><br>
                        <strong>可能的原因:</strong>
                        <ul>
                            <li>RHI 设备初始化失败</li>
                            <li>Core 组件依赖缺失</li>
                            <li>WebGL 上下文创建失败</li>
                            <li>着色器编译或链接错误</li>
                        </ul>
                    </div>
                `;
                errorPanel.style.display = 'block';
            }
        }

        // 创建全局演示实例
        window.demo = new CoreRenderTestDemo();

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            window.demo.init();
        });
    </script>
</body>
</html> 