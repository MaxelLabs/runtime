# MAX引擎核心层设计文档

## 一、核心架构分析

从当前目录结构分析，MAX引擎采用了基于实体组件系统(ECS)的架构，结合了现代渲染硬件接口(RHI)抽象层设计。以下是对现有架构的优化重构方案。数学库为@maxellabs/math，在Core包中只能使用interface/rhi中的相关接口。webgl/webgpu实现不在Core包，在Engine包。

## 二、建议的目录结构

```
/core/src/
├── Engine.ts                      # 引擎主类
├── index.ts                       # 模块导出
├── constants.ts                   # 全局常量
│
├── base/                          # 基础系统
│   ├── index.ts                   # 导出所有基础类
│   ├── Component.ts               # 组件基类
│   ├── Entity.ts                  # 实体类
│   ├── EventDispatcher.ts         # 事件分发系统
│   ├── IOC.ts                     # 依赖注入容器
│   ├── MaxObject.ts               # 基础对象类
│   ├── ObjectPool.ts              # 对象池
│   ├── ReferResource.ts           # 引用计数资源
│   ├── Time.ts                    # 时间管理
│   └── Transform.ts               # 变换组件
│
├── camera/                        # 相机系统
│   ├── index.ts
│   ├── Camera.ts                  # 相机基类
│   ├── PerspectiveCamera.ts       # 透视相机 (缺失)
│   └── OrthographicCamera.ts      # 正交相机 (缺失)
│
├── interface/                     # 接口定义
│   ├── index.ts
│   └── rhi/                       # 渲染硬件接口
│
├── geometry/                      # 几何体系统
│   ├── index.ts
│   ├── Geometry.ts                # 几何体类
│   └── GeometryUtils.ts           # 几何体工具 (缺失)
│
├── input/                         # 输入系统
│   ├── index.ts
│   └── InputManager.ts            # 输入管理器
│
├── light/                         # 光照系统
│   ├── index.ts
│   ├── Light.ts                   # 光照基类
│   ├── DirectionalLight.ts        # 方向光 (缺失)
│   ├── PointLight.ts              # 点光源 (缺失)
│   └── SpotLight.ts               # 聚光灯 (缺失)
│
├── material/                      # 材质系统
│   ├── index.ts
│   ├── constants.ts               # 材质常量
│   └── Material.ts                # 材质类
│
├── renderer/                      # 渲染系统
│   ├── index.ts
│   ├── RenderContext.ts           # 渲染上下文
│   ├── RenderElement.ts           # 渲染元素
│   ├── SubRenderElement.ts        # 子渲染元素
│   ├── RenderQueue.ts             # 渲染队列
│   ├── BatcherManager.ts          # 批处理管理器
│   ├── CullingResults.ts          # 视锥剔除结果
│   └──Mesh.ts                     # 网格组件
│
├── resource/                      # 资源管理
│   ├── index.ts
│   ├── ResourceManager.ts         # 资源管理器
│   └── EnhancedResourceManager.ts # 增强资源管理器
│
├── scene/                         # 场景系统
│   ├── index.ts
│   ├── Scene.ts                   # 场景类
│   └── SceneManager.ts            # 场景管理器
│
├── shader/                        # 着色器系统
│   ├── index.ts
│   ├── Shader.ts                  # 着色器类
│   └── ShaderData.ts              # 着色器数据
│
├── texture/                       # 纹理系统
│   ├── index.ts
│   └── Texture2D.ts               # 2D纹理
│
├── animation/                     # 动画系统 (缺失)
│   ├── index.ts
│   ├── Animation.ts               # 动画基类
│   └── AnimationClip.ts           # 动画片段
│
├── physics/                       # 物理系统 (缺失)
│   ├── index.ts
│   └── PhysicsWorld.ts            # 物理世界
│
└── debug/                         # 调试工具 (缺失)
    ├── index.ts
    ├── Logger.ts                  # 日志系统
    └── Stats.ts                   # 性能统计
```

# MAX引擎核心文件结构详细解释

## 根目录文件

### Engine.ts
引擎的主类，负责初始化和管理整个引擎的生命周期。它协调各个子系统，维护主渲染循环，处理引擎状态(初始化、运行、暂停、销毁)，并提供全局服务访问点。

### index.ts
模块导出文件，将核心包中的关键类和功能导出，方便外部使用。

### constants.ts
定义全局常量，包括引擎版本号、默认配置值、渲染相关常量等。

## 基础系统 (base/)

`base` 目录中的文件构成了引擎的核心基础设施，每个文件都有特定的使用场景：

### 核心系统

- **maxObject.ts**：基础对象类，作为引擎中大多数对象的基类，提供通用功能如唯一ID、名称管理等
- **EventDispatcher.ts**：事件分发系统，用于组件间通信，支持事件冒泡和捕获，以及层级结构事件传递
- **event.ts**：定义基础事件类型和事件对象结构，是事件系统的基础

#### 场景和实体系统

- **entity.ts**：实体类，代表游戏世界中的对象，管理组件和层级结构
- **component.ts**：组件基类，实现组件化设计模式，可附加到实体上提供特定功能
- **transform.ts**：变换组件，处理3D空间中的位置、旋转和缩放，支持父子级变换继承

#### 资源管理

- **ReferResource.ts**：引用计数资源基类，管理需要手动释放的资源（如纹理、材质、网格等）
- **ObjectPool.ts**：对象池实现，通过重用对象减少内存分配和垃圾回收，提高性能
- **ObjectPoolManager.ts**：对象池管理器，统一管理多个对象池，提供性能监控和预热功能

#### 工具和基础设施

- **time.ts**：时间管理类，控制游戏时间流逝、帧率和时间缩放
- **canvas.ts**：画布封装，管理HTML Canvas元素和尺寸调整
- **IOC.ts**：依赖注入容器，解决组件间循环依赖问题，实现松耦合架构

#### 典型使用场景

1. **游戏对象创建**：创建实体(entity.ts)，添加变换组件(transform.ts)和其他自定义组件(component.ts)
2. **事件通信**：使用EventDispatcher进行游戏对象间通信
3. **资源管理**：使用ReferResource管理资源生命周期，用ObjectPool重用频繁创建的对象
4. **时间控制**：使用time.ts控制游戏速度、暂停和恢复

这些文件共同构成了引擎的基础架构，支持游戏开发中的核心功能需求。

## 相机系统 (camera/)

### Camera.ts
相机基类，定义相机的基本属性和功能，如视口、清除标志、投影矩阵计算等。

### PerspectiveCamera.ts (缺失)
透视相机实现，模拟人眼视角，提供视野角度、近远裁剪面等参数控制。

### OrthographicCamera.ts (缺失)
正交相机实现，提供无透视效果的投影，适用于2D游戏或UI渲染。

## 接口定义 (interface/)

### rhi/ (渲染硬件接口)
抽象渲染硬件接口，定义缓冲区、纹理、着色器等资源接口，抽象渲染管线和状态控制，提供枚举定义各种渲染状态和标志。实现跨平台图形API支持。

## 几何体系统 (geometry/)

### Geometry.ts
几何体类，存储顶点数据、索引数据、法线、UV等几何信息，支持自定义顶点属性。

### GeometryUtils.ts (缺失)
几何体工具类，提供创建基本形状(立方体、球体等)、几何体变换、合并、细分等操作。

## 输入系统 (input/)

### InputManager.ts
输入管理器，处理键盘、鼠标、触摸等输入设备的事件，提供输入状态查询和事件回调。

## 光照系统 (light/)

### Light.ts
光照基类，定义光照的通用属性如颜色、强度、阴影设置等。

### DirectionalLight.ts (缺失)
方向光实现，模拟来自无限远处的平行光源，常用于模拟太阳光。

### PointLight.ts (缺失)
点光源实现，从一个点向四周发散光线，具有位置和衰减属性。

### SpotLight.ts (缺失)
聚光灯实现，模拟投射一个锥形光束的光源，有方向、角度和衰减属性。

## 材质系统 (material/)

### constants.ts
材质相关常量定义，包括渲染模式、混合模式、深度测试等参数的预设值。

### Material.ts
材质类，定义渲染对象的外观和着色方式，管理着色器参数和渲染状态。

## 渲染系统 (renderer/)

### RenderContext.ts
渲染上下文，封装渲染状态和操作，管理渲染队列和渲染过程。

### RenderElement.ts
渲染元素，包含渲染一个对象所需的全部信息(几何体、材质、变换等)。

### SubRenderElement.ts
子渲染元素，用于处理需要多次绘制的复杂渲染情况，如多材质模型。

### RenderQueue.ts
渲染队列，管理渲染元素的排序和处理，支持透明度排序，优化渲染顺序减少状态切换。

### BatcherManager.ts
批处理管理器，合并相似的渲染元素以减少绘制调用，优化渲染性能。

### CullingResults.ts
视锥剔除结果，存储经过视锥体剔除后的可见对象列表。

### Mesh.ts
网格组件，包含几何体和材质信息，管理网格的可见性和阴影特性，准备渲染数据。

## 资源管理 (resource/)

### ResourceManager.ts
资源管理器，负责资源加载、缓存和卸载，处理资源引用计数。

### EnhancedResourceManager.ts
增强资源管理器，提供更高级的资源管理功能，如异步加载、依赖管理、资源预加载等。

## 场景系统 (scene/)

### Scene.ts
场景类，管理场景中的所有实体，处理场景生命周期(加载、更新、卸载)，维护场景图。

### SceneManager.ts
场景管理器，管理多个场景，处理场景切换，控制场景加载流程。

## 着色器系统 (shader/)

### Shader.ts
着色器类，封装顶点着色器和片元着色器，管理着色器编译和参数设置。

### ShaderData.ts
着色器数据，存储和管理着色器使用的各种参数和纹理。

## 纹理系统 (texture/)

### Texture2D.ts
2D纹理类，管理图像数据，支持纹理加载、设置和参数配置。

## 动画系统 (animation/) (缺失)

### Animation.ts
动画基类，提供动画播放控制、事件回调等基本功能。

### AnimationClip.ts
动画片段，存储特定动画的关键帧数据和播放参数。

## 物理系统 (physics/) (缺失)

### PhysicsWorld.ts
物理世界，管理物理模拟环境，处理碰撞检测和物理反应。

## 调试工具 (debug/) (缺失)

### Logger.ts
日志系统，提供不同级别的日志记录功能，支持日志格式化和输出控制。

### Stats.ts
性能统计工具，监控FPS、内存使用、渲染调用次数等性能指标。

## 三、关键模块职责说明

### 1. 核心模块

#### Engine.ts
- **职责**：引擎的核心类，管理引擎生命周期、主循环、场景和渲染
- **功能**：
  - 初始化和管理渲染环境
  - 维护主渲染循环
  - 处理引擎状态(初始化、运行、暂停、销毁)
  - 协调各个子系统的更新和渲染
  - 提供全局服务访问点

### 2. 基础系统

#### IOC.ts
- **职责**：依赖注入容器，解决组件间循环依赖问题
- **功能**：
  - 注册和获取服务
  - 提供服务标识符常量
  - 支持服务生命周期管理

#### Entity.ts
- **职责**：实体类，表示场景中的一个对象
- **功能**：
  - 组件管理(添加、获取、移除)
  - 子实体管理
  - 场景关联
  - 激活状态控制

#### Component.ts
- **职责**：组件基类，所有功能组件的基础
- **功能**：
  - 定义组件生命周期(Awake、Enable、Disable、Destroy)
  - 提供与实体的关联
  - 处理启用/禁用逻辑

### 3. 渲染系统 

#### interface/rhi/
- **职责**：抽象渲染硬件接口，实现跨平台图形API
- **功能**：
  - 定义缓冲区、纹理、着色器等资源接口
  - 抽象渲染管线和状态控制
  - 枚举定义各种渲染状态和标志

#### renderer/Mesh.ts
- **职责**：网格组件，包含几何体和材质信息
- **功能**：
  - 管理几何体和材质
  - 处理网格的可见性、阴影特性
  - 准备渲染数据

#### renderer/RenderQueue.ts
- **职责**：管理渲染元素的排序和处理
- **功能**：
  - 根据材质特性对渲染元素进行排序
  - 支持透明度排序
  - 优化渲染顺序减少状态切换

#### BatcherManager.ts  
- **职责**：批处理管理，合并相似的渲染元素
- **功能**：
  - 检测可合并的渲染元素
  - 准备批处理数据
  - 优化绘制调用次数

### 4. 资源管理

#### ResourceManager.ts
- **职责**：管理引擎中的各种资源
- **功能**：
  - 资源加载、缓存和卸载
  - 资源引用计数
  - 处理不同类型资源的生命周期

### 5. 场景系统

#### scene/Scene.ts
- **职责**：场景类，管理场景中的所有实体
- **功能**：
  - 实体管理(添加、查找、移除)
  - 场景生命周期(加载、更新、卸载)
  - 维护场景图

#### SceneManager.ts
- **职责**：管理多个场景，处理场景切换
- **功能**：
  - 场景创建和管理
  - 活动场景设置与切换
  - 场景加载流程控制

## 四、缺失模块分析

### 3. 物理系统
缺少物理引擎接口，用于处理碰撞检测和物理模拟。

### 4. 动画系统
需要添加动画系统，支持骨骼动画、关键帧动画等。

### 5. 扩展光照类型
现有Light.ts基类需要扩展为具体的光照类型实现。

### 6. 调试工具
缺少性能监控、日志记录等调试工具。

## 五、设计建议

1. **统一命名规范**：保持一致的文件命名约定(例如使用大驼峰)
3. **扩展组件库**：添加更多内置组件以满足常见需求
4. **优化资源加载**：引入异步加载和资源依赖管理
5. **添加单元测试**：为核心模块添加测试用例

## 六、实现优先级

3. 扩展光照和相机系统
4. 动画系统
5. 物理系统
6. 调试和性能工具

通过以上结构优化和模块补充，MAX引擎核心层将更加完整、可扩展，既保持良好的跨平台兼容性，又能支持现代图形API的高级特性。